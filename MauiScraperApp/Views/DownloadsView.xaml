<ContentView xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:MauiScraperApp.ViewModels"
             xmlns:m="clr-namespace:MauiScraperApp.Services"
             x:Class="MauiScraperApp.Views.DownloadsView"
             x:DataType="vm:DownloadsViewModel">

    <Grid RowDefinitions="Auto, Auto, Auto, *">
        
        <!-- Status Bar -->
        <Frame Grid.Row="0" BackgroundColor="#2196F3" Padding="10" CornerRadius="0">
            <Label Text="{Binding StatusMessage}" TextColor="White" FontSize="12" HorizontalOptions="Center"/>
        </Frame>

        <!-- Filters -->
        <SearchBar Grid.Row="1" Placeholder="Filter..." Text="{Binding SearchText}" Margin="5"/>
        <ScrollView Grid.Row="2" Orientation="Horizontal" HorizontalScrollBarVisibility="Never" Padding="5">
            <HorizontalStackLayout BindableLayout.ItemsSource="{Binding FilterOptions}" Spacing="5">
                <BindableLayout.ItemTemplate>
                    <DataTemplate>
                        <Button Text="{Binding .}" 
                                Command="{Binding Source={RelativeSource AncestorType={x:Type vm:DownloadsViewModel}}, Path=SelectedFilterStatus}" 
                                CommandParameter="{Binding .}"
                                HeightRequest="35"
                                FontSize="12"
                                Padding="10,0"/>
                    </DataTemplate>
                </BindableLayout.ItemTemplate>
            </HorizontalStackLayout>
        </ScrollView>
        <Picker Grid.Row="2" Title="Status" ItemsSource="{Binding FilterOptions}" SelectedItem="{Binding SelectedFilterStatus}" Margin="5" IsVisible="True"/>

        <!-- List -->
        <CollectionView Grid.Row="3" ItemsSource="{Binding FilteredDownloads}" SelectionMode="None">
            <CollectionView.EmptyView>
                <Label Text="No downloads found." HorizontalOptions="Center" VerticalOptions="Center" TextColor="Gray"/>
            </CollectionView.EmptyView>
            <CollectionView.ItemTemplate>
                <DataTemplate x:DataType="m:RemoteTorrentInfo">
                    <Frame Margin="5" Padding="5" BorderColor="LightGray">
                        <Grid RowDefinitions="Auto, Auto, Auto" ColumnDefinitions="*, Auto" RowSpacing="2">
                            
                            <!-- Name & Status -->
                            <Label Grid.Row="0" Grid.Column="0" Text="{Binding Name}" LineBreakMode="TailTruncation" FontAttributes="Bold" FontSize="14"/>
                            <Label Grid.Row="0" Grid.Column="1" Text="{Binding State}" TextColor="{Binding State, Converter={StaticResource StateToColorConverter}}" FontAttributes="Bold" HorizontalOptions="End"/>

                            <!-- Progress Bar -->
                            <ProgressBar Grid.Row="1" Grid.ColumnSpan="2" Progress="{Binding Progress}" ProgressColor="{Binding State, Converter={StaticResource StateToColorConverter}}"/>

                            <!-- Stats -->
                            <HorizontalStackLayout Grid.Row="2" Grid.Column="0" Spacing="10">
                                <Label Text="{Binding ProgressPercent}" TextColor="{StaticResource Primary}"/>
                                <Label Text="{Binding SizeFormatted}" TextColor="Gray"/>
                                <Label Text="{Binding DownloadSpeedFormatted}" TextColor="Green"/>
                            </HorizontalStackLayout>

                            <!-- Actions -->
                            <HorizontalStackLayout Grid.Row="2" Grid.Column="1" Spacing="5">
                                <ImageButton Source="{Binding State, Converter={StaticResource StateToPausedConverter}}" 
                                             Command="{Binding Source={RelativeSource AncestorType={x:Type vm:DownloadsViewModel}}, Path=ResumeTorrentCommand}" 
                                             CommandParameter="{Binding .}" HeightRequest="25" WidthRequest="25"/>
                                <ImageButton Source="pause.png" 
                                             Command="{Binding Source={RelativeSource AncestorType={x:Type vm:DownloadsViewModel}}, Path=PauseTorrentCommand}" 
                                             CommandParameter="{Binding .}" HeightRequest="25" WidthRequest="25"/>
                                <ImageButton Source="delete.png" 
                                             Command="{Binding Source={RelativeSource AncestorType={x:Type vm:DownloadsViewModel}}, Path=DeleteTorrentCommand}" 
                                             CommandParameter="{Binding .}" HeightRequest="25" WidthRequest="25"/>
                            </HorizontalStackLayout>
                        </Grid>
                    </Frame>
                </DataTemplate>
            </CollectionView.ItemTemplate>
        </CollectionView>
    </Grid>
</ContentView>
