<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:MauiScraperApp.ViewModels"
             x:Class="MauiScraperApp.Views.ConnectionView"
             x:DataType="viewmodels:ConnectionViewModel"
             Title="Connect to PC"
             Shell.NavBarIsVisible="False">

    <ScrollView>
        <VerticalStackLayout Padding="20" Spacing="20">

            <!-- Logo/Header -->
            <Label Text="ðŸ–¥ï¸"
                   FontSize="80"
                   HorizontalOptions="Center"
                   Margin="0,40,0,0"/>

            <Label Text="Torrent Remote"
                   FontSize="32"
                   FontAttributes="Bold"
                   HorizontalOptions="Center"/>

            <Label Text="Connect to your Windows PC"
                   FontSize="16"
                   TextColor="Gray"
                   HorizontalOptions="Center"
                   Margin="0,0,0,20"/>

            <!-- Connection Status -->
            <Frame BackgroundColor="{StaticResource Primary}"
                   Padding="15"
                   CornerRadius="10"
                   IsVisible="{Binding IsConnected}">
                <VerticalStackLayout Spacing="10">
                    <Label Text="âœ“ Connected"
                           FontSize="18"
                           FontAttributes="Bold"
                           TextColor="White"
                           HorizontalOptions="Center"/>
                    <Label Text="{Binding StatusMessage}"
                           TextColor="White"
                           HorizontalOptions="Center"/>
                    <Button Text="Continue to App"
                            Command="{Binding ContinueToAppCommand}"
                            BackgroundColor="White"
                            TextColor="{StaticResource Primary}"/>
                    <Button Text="Disconnect"
                            Command="{Binding DisconnectCommand}"
                            BackgroundColor="Transparent"
                            BorderColor="White"
                            BorderWidth="1"
                            TextColor="White"/>
                </VerticalStackLayout>
            </Frame>

            <!-- Manual Connection -->
            <Frame IsVisible="{Binding IsConnected, Converter={StaticResource InverseBoolConverter}}"
                   Padding="20"
                   CornerRadius="10"
                   BorderColor="LightGray">
                <VerticalStackLayout Spacing="15">
                    <Label Text="Manual Connection"
                           FontSize="18"
                           FontAttributes="Bold"/>

                    <Label Text="Server IP Address"/>
                    <Entry Text="{Binding ServerIp}"
                           Placeholder="e.g., 192.168.1.100"
                           Keyboard="Text"/>

                    <Label Text="Port"/>
                    <Entry Text="{Binding ServerPort}"
                           Placeholder="5000"
                           Keyboard="Numeric"/>

                    <Button Text="Connect"
                            Command="{Binding ConnectCommand}"
                            IsEnabled="{Binding IsConnecting, Converter={StaticResource InverseBoolConverter}}"
                            BackgroundColor="{StaticResource Primary}"
                            TextColor="White"
                            HeightRequest="50"
                            Margin="0,10,0,0"/>

                    <ActivityIndicator IsRunning="{Binding IsConnecting}"
                                     IsVisible="{Binding IsConnecting}"
                                     HorizontalOptions="Center"/>

                    <Label Text="{Binding StatusMessage}"
                           TextColor="Gray"
                           HorizontalOptions="Center"
                           IsVisible="{Binding StatusMessage, Converter={StaticResource StringNotEmptyConverter}}"/>
                </VerticalStackLayout>
            </Frame>

            <!-- Auto Discovery -->
            <Frame IsVisible="{Binding IsConnected, Converter={StaticResource InverseBoolConverter}}"
                   Padding="20"
                   CornerRadius="10"
                   BorderColor="LightGray">
                <VerticalStackLayout Spacing="15">
                    <Label Text="Auto Discovery"
                           FontSize="18"
                           FontAttributes="Bold"/>

                    <Label Text="Automatically find servers on your network (takes 30-60 seconds)"
                           TextColor="Gray"/>

                    <Button Text="Scan Network"
                            Command="{Binding ScanNetworkCommand}"
                            IsEnabled="{Binding IsScanning, Converter={StaticResource InverseBoolConverter}}"
                            BackgroundColor="#2196F3"
                            TextColor="White"
                            HeightRequest="50"/>

                    <ActivityIndicator IsRunning="{Binding IsScanning}"
                                     IsVisible="{Binding IsScanning}"
                                     HorizontalOptions="Center"/>

                    <!-- Discovered Servers List -->
                    <CollectionView ItemsSource="{Binding DiscoveredServers}"
                                  SelectionMode="None">
                        <CollectionView.EmptyView>
                            <Label Text="No servers found yet. Click 'Scan Network' to search."
                                   TextColor="Gray"
                                   HorizontalOptions="Center"
                                   Margin="0,10"/>
                        </CollectionView.EmptyView>
                        <CollectionView.ItemTemplate>
                            <DataTemplate x:DataType="{x:Type x:String}">
                                <Frame Padding="10"
                                       Margin="0,5"
                                       BackgroundColor="#E3F2FD"
                                       CornerRadius="5">
                                    <Grid ColumnDefinitions="*, Auto">
                                        <Label Grid.Column="0"
                                               Text="{Binding .}"
                                               VerticalOptions="Center"
                                               FontSize="16"/>
                                        <Button Grid.Column="1"
                                                Text="Select"
                                                Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:ConnectionViewModel}}, Path=SelectServerCommand}"
                                                CommandParameter="{Binding .}"
                                                BackgroundColor="{StaticResource Primary}"
                                                TextColor="White"
                                                Padding="15,5"/>
                                    </Grid>
                                </Frame>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>
                </VerticalStackLayout>
            </Frame>

            <!-- Setup Instructions -->
            <Frame IsVisible="{Binding IsConnected, Converter={StaticResource InverseBoolConverter}}"
                   Padding="15"
                   CornerRadius="10"
                   BackgroundColor="#FFF3E0"
                   BorderColor="Orange">
                <VerticalStackLayout Spacing="10">
                    <Label Text="â„¹ï¸ Setup Required"
                           FontSize="16"
                           FontAttributes="Bold"/>
                    <Label Text="Make sure the Torrent Remote Service is running on your Windows PC and qBittorrent Web UI is enabled."
                           TextColor="Black"/>
                    <Label Text="The PC and phone must be on the same WiFi network."
                           TextColor="Black"
                           FontAttributes="Italic"/>
                </VerticalStackLayout>
            </Frame>

        </VerticalStackLayout>
    </ScrollView>
</ContentPage>